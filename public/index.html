<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Multiplayer</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/vue-i18n@9/dist/vue-i18n.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'parchment': {
                            50: '#fefdf8',
                            100: '#fdf9e7',
                            200: '#faf0c4',
                            300: '#f5e197',
                            400: '#edc968',
                            500: '#e4b143',
                            600: '#d49c35',
                            700: '#b17f2e',
                            800: '#8f652b',
                            900: '#755327',
                        },
                        'ink': {
                            600: '#4a5568',
                            700: '#2d3748',
                            800: '#1a202c',
                        }
                    },
                    fontFamily: {
                        'serif': ['Crimson Text', 'Libre Baskerville', 'serif'],
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap');
        
        .book-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .book-page {
            background: linear-gradient(135deg, #fefdf8 0%, #fdf9e7 100%);
            position: relative;
        }
        
        .book-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23f5e197' fill-opacity='0.05'%3E%3Ccircle cx='30' cy='30' r='1'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
        }
    </style>
</head>

<body class="book-page min-h-screen font-serif">
    <div id="app">
        <div class="container mx-auto px-4 py-8 max-w-4xl" :key="currentLocale">
            <!-- Language Selector -->
            <div class="absolute top-4 right-4">
                <select
                    :value="currentLocale"
                    @change="changeLanguage($event.target.value)"
                    class="text-sm bg-parchment-100 border border-parchment-300 rounded px-2 py-1 text-ink-700 focus:outline-none focus:ring-1 focus:ring-parchment-500"
                >
                    <option value="en">ðŸ‡ºðŸ‡¸ English</option>
                    <option value="pl">ðŸ‡µðŸ‡± Polski</option>
                    <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
                    <option value="de">ðŸ‡©ðŸ‡ª Deutsch</option>
                </select>
            </div>
            </div>

            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-ink-800 mb-2">ðŸ“š Quiz Multiplayer</h1>
                <p class="text-ink-600 text-lg">{{ $t('subtitle') }}</p>
            </header>

            <!-- Error Message -->
            <div v-if="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                {{ error }}
            </div>

            <!-- Success Message -->
            <div v-if="message" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                {{ message }}
            </div>

            <!-- Menu State -->
            <div v-if="gameState === 'menu'" class="max-w-md mx-auto">
                <div class="bg-parchment-100 p-8 rounded-lg book-shadow border border-parchment-300">
                    <!-- Create New Game Section -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-ink-800 mb-6 text-center">{{ $t('createNewGame') }}</h2>

                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="block text-ink-700 font-sans mb-2">{{ $t('yourName') }}:</label>
                                <input
                                    v-model="playerNameCreate"
                                    type="text"
                                    class="w-full p-3 border border-parchment-400 rounded-lg bg-parchment-50 text-ink-800 font-sans focus:outline-none focus:ring-2 focus:ring-parchment-500"
                                    :placeholder="$t('enterYourName')"
                                    maxlength="20"
                                    @keyup.enter="createGame"
                                >
                            </div>
                        </div>

                        <button
                            @click="createGame"
                            class="w-full bg-parchment-500 hover:bg-parchment-600 text-white font-sans font-bold py-3 px-6 rounded-lg book-shadow transition-colors"
                        >
                            ðŸŽ² {{ $t('createNewGameButton') }}
                        </button>
                    </div>

                    <!-- Divider -->
                    <div class="relative my-8">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-parchment-400"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-4 bg-parchment-100 text-ink-600 font-sans">{{ $t('or') }}</span>
                        </div>
                    </div>

                    <!-- Join Game Section -->
                    <div>
                        <h2 class="text-2xl font-bold text-ink-800 mb-6 text-center">{{ $t('joinGame') }}</h2>

                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="block text-ink-700 font-sans mb-2">{{ $t('yourName') }}:</label>
                                <input
                                    v-model="playerNameJoin"
                                    type="text"
                                    class="w-full p-3 border border-parchment-400 rounded-lg bg-parchment-50 text-ink-800 font-sans focus:outline-none focus:ring-2 focus:ring-parchment-500"
                                    :placeholder="$t('enterYourName')"
                                    maxlength="20"
                                >
                            </div>

                            <div>
                                <label class="block text-ink-700 font-sans mb-2">{{ $t('gameCode') }}:</label>
                                <input
                                    v-model="gameCode"
                                    type="text"
                                    class="w-full p-3 border border-parchment-400 rounded-lg bg-parchment-50 text-ink-800 font-sans focus:outline-none focus:ring-2 focus:ring-parchment-500"
                                    :placeholder="$t('enterGameCode')"
                                    maxlength="4"
                                    @keyup.enter="joinGame"
                                >
                            </div>
                        </div>

                        <button
                            @click="joinGame"
                            class="w-full bg-ink-600 hover:bg-ink-700 text-white font-sans font-bold py-3 px-6 rounded-lg book-shadow transition-colors"
                        >
                            ðŸšª {{ $t('joinGameButton') }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Waiting State -->
            <div v-if="gameState === 'waiting'" class="text-center">
                <div class="bg-parchment-100 p-8 rounded-lg book-shadow border border-parchment-300">
                    <h2 class="text-2xl font-bold text-ink-800 mb-4">{{ $t('waitingForPlayer') }}</h2>
                    <p class="text-ink-600 mb-4">{{ $t('gameCodeLabel') }}: <span class="font-bold text-2xl">{{ room?.code }}</span></p>
                    <p class="text-ink-600">{{ $t('shareCode') }}</p>
                    <div class="mt-6">
                        <button @click="resetGame" class="bg-gray-500 hover:bg-gray-600 text-white font-sans font-bold py-2 px-4 rounded">
                            {{ $t('backToMenu') }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Playing State -->
            <div v-if="gameState === 'playing'" class="space-y-6">
                <!-- Game Info -->
                <div class="bg-parchment-100 p-6 rounded-lg book-shadow border border-parchment-300">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-ink-800">{{ $t('gameInProgress') }}</h2>
                        <div class="text-ink-600 font-sans">
                            {{ $t('round') }} {{ room?.currentRound || 1 }}/{{ room?.maxRounds || 3 }}
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <div class="font-bold text-ink-800">{{ room?.players[0]?.name }}</div>
                            <div class="text-2xl font-bold text-parchment-600">{{ room?.players[0]?.score || 0 }}</div>
                            <div class="text-sm text-ink-600">{{ $t('completedRounds') }}: {{ room?.roundsCompleted?.[room?.players[0]?.id] || 0 }}</div>
                        </div>
                        <div class="text-center">
                            <div class="font-bold text-ink-800">{{ room?.players[1]?.name }}</div>
                            <div class="text-2xl font-bold text-parchment-600">{{ room?.players[1]?.score || 0 }}</div>
                            <div class="text-sm text-ink-600">{{ $t('completedRounds') }}: {{ room?.roundsCompleted?.[room?.players[1]?.id] || 0 }}</div>
                        </div>
                    </div>
                </div>

                <!-- Question Form (when it's player's turn to ask) -->
                <div v-if="canAskQuestion" class="bg-parchment-100 p-6 rounded-lg book-shadow border border-parchment-300">
                    <h3 class="text-xl font-bold text-ink-800 mb-4">{{ $t('yourTurnAsk') }}</h3>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-ink-700 font-sans mb-2">{{ $t('questionText') }}:</label>
                            <textarea
                                v-model="questionForm.text"
                                class="w-full p-3 border border-parchment-400 rounded-lg bg-parchment-50 text-ink-800 font-sans focus:outline-none focus:ring-2 focus:ring-parchment-500"
                                rows="3"
                                :placeholder="$t('enterQuestion')"
                            ></textarea>
                        </div>

                        <div>
                            <label class="block text-ink-700 font-sans mb-2">{{ $t('answers') }}:</label>
                            <div class="space-y-2">
                                <div v-for="(answer, index) in questionForm.answers" :key="index" class="flex items-center space-x-2">
                                    <input
                                        type="radio"
                                        :name="'correct-answer'"
                                        :value="index"
                                        v-model="questionForm.correctAnswer"
                                        class="text-parchment-500"
                                    >
                                    <input
                                        v-model="questionForm.answers[index]"
                                        type="text"
                                        class="flex-1 p-2 border border-parchment-400 rounded bg-parchment-50 text-ink-800 font-sans focus:outline-none focus:ring-2 focus:ring-parchment-500"
                                        :placeholder="$t('answer') + ' ' + (index + 1)"
                                    >
                                </div>
                            </div>
                            <p class="text-sm text-ink-600 mt-2">{{ $t('selectCorrectAnswer') }}</p>
                        </div>

                        <button
                            @click="submitQuestion"
                            class="w-full bg-parchment-500 hover:bg-parchment-600 text-white font-sans font-bold py-3 px-6 rounded-lg book-shadow transition-colors"
                        >
                            {{ $t('askQuestion') }}
                        </button>
                    </div>
                </div>

                <!-- Answer Form (when it's player's turn to answer) -->
                <div v-if="canAnswerQuestion" class="bg-parchment-100 p-6 rounded-lg book-shadow border border-parchment-300">
                    <h3 class="text-xl font-bold text-ink-800 mb-4">{{ $t('playerAsks', { name: otherPlayer?.name }) }}:</h3>

                    <div class="bg-parchment-50 p-4 rounded-lg mb-4">
                        <p class="text-ink-800 text-lg">{{ room?.currentQuestion?.text }}</p>
                    </div>

                    <div class="space-y-2 mb-4">
                        <div v-for="(answer, index) in room?.currentQuestion?.answers" :key="index">
                            <label class="flex items-center space-x-3 p-3 border border-parchment-300 rounded-lg hover:bg-parchment-50 cursor-pointer">
                                <input
                                    type="radio"
                                    :value="index"
                                    v-model="selectedAnswer"
                                    class="text-parchment-500"
                                >
                                <span class="text-ink-800">{{ answer }}</span>
                            </label>
                        </div>
                    </div>

                    <button
                        @click="submitAnswer"
                        class="w-full bg-ink-600 hover:bg-ink-700 text-white font-sans font-bold py-3 px-6 rounded-lg book-shadow transition-colors"
                        :disabled="selectedAnswer === -1"
                    >
                        {{ $t('answer') }}
                    </button>
                </div>

                <!-- Waiting for other player -->
                <div v-if="!canAskQuestion && !canAnswerQuestion" class="bg-parchment-100 p-6 rounded-lg book-shadow border border-parchment-300 text-center">
                    <h3 class="text-xl font-bold text-ink-800 mb-2">{{ $t('waiting') }}...</h3>
                    <p class="text-ink-600 flex items-center justify-center">
                        <span class="inline-block w-4 h-4 border-2 border-ink-600 border-t-transparent rounded-full animate-spin mr-2"></span>
                        <template v-if="room?.currentQuestion">
                            {{ $t('playerThinking', { name: otherPlayer?.name }) }}
                        </template>
                        <template v-else>
                            {{ $t('playerPreparing', { name: otherPlayer?.name }) }}
                        </template>
                    </p>
                </div>
            </div>

            <!-- Finished State -->
            <div v-if="gameState === 'finished'" class="text-center">
                <div class="bg-parchment-100 p-8 rounded-lg book-shadow border border-parchment-300">
                    <h2 class="text-3xl font-bold text-ink-800 mb-4">ðŸŽ‰ {{ $t('gameFinished') }}!</h2>
                    <p class="text-xl text-ink-600 mb-6">
                        {{ $t('winner') }}: <span class="font-bold">{{ room?.winner ? room.players.find(p => p.id === room.winner)?.name : $t('tie') }}</span>
                    </p>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="text-center">
                            <div class="font-bold text-ink-800">{{ room?.players[0]?.name }}</div>
                            <div class="text-3xl font-bold text-parchment-600">{{ room?.players[0]?.score || 0 }}</div>
                        </div>
                        <div class="text-center">
                            <div class="font-bold text-ink-800">{{ room?.players[1]?.name }}</div>
                            <div class="text-3xl font-bold text-parchment-600">{{ room?.players[1]?.score || 0 }}</div>
                        </div>
                    </div>

                    <button @click="resetGameAfterFinish" class="bg-parchment-500 hover:bg-parchment-600 text-white font-sans font-bold py-3 px-6 rounded-lg book-shadow transition-colors">
                        {{ $t('newGame') }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch } = Vue;
        const { createI18n } = VueI18n;

        // Funkcja do wykrywania jÄ™zyka przeglÄ…darki
        function getBrowserLanguage() {
            // Najpierw sprawdÅº zapisane preferencje
            const savedLanguage = localStorage.getItem('preferredLanguage');
            if (savedLanguage) {
                return savedLanguage;
            }

            // JeÅ›li nie ma zapisanych preferencji, uÅ¼yj jÄ™zyka przeglÄ…darki
            const lang = navigator.language || navigator.userLanguage;
            const langCode = lang.split('-')[0];
            const supportedLanguages = ['pl', 'en', 'es', 'de'];
            return supportedLanguages.includes(langCode) ? langCode : 'en';
        }

        // Konfiguracja tÅ‚umaczeÅ„
        const messages = {
            pl: {
                subtitle: 'Gra dla dwÃ³ch graczy',
                createNewGame: 'StwÃ³rz nowÄ… grÄ™',
                yourName: 'Twoje imiÄ™',
                enterYourName: 'Wpisz swoje imiÄ™...',
                createNewGameButton: 'StwÃ³rz nowÄ… grÄ™',
                or: 'lub',
                joinGame: 'DoÅ‚Ä…cz do gry',
                gameCode: 'Kod gry',
                enterGameCode: 'Wpisz 4-cyfrowy kod...',
                joinGameButton: 'DoÅ‚Ä…cz do gry',
                waitingForPlayer: 'Oczekiwanie na drugiego gracza...',
                gameCodeLabel: 'Kod gry',
                shareCode: 'Podziel siÄ™ tym kodem z drugim graczem',
                backToMenu: 'PowrÃ³t do menu',
                gameInProgress: 'Gra w toku',
                round: 'Runda',
                completedRounds: 'UkoÅ„czone rundy',
                yourTurnAsk: 'Twoja kolej - zadaj pytanie!',
                questionText: 'TreÅ›Ä‡ pytania',
                enterQuestion: 'Wpisz swoje pytanie...',
                answers: 'Odpowiedzi',
                answer: 'OdpowiedÅº',
                selectCorrectAnswer: 'Zaznacz poprawnÄ… odpowiedÅº',
                askQuestion: 'Zadaj pytanie',
                playerAsks: '{name} pyta',
                waiting: 'Oczekiwanie',
                playerThinking: '{name} myÅ›li nad odpowiedziÄ…',
                playerPreparing: '{name} przygotowuje pytanie',
                gameFinished: 'Gra zakoÅ„czona!',
                winner: 'ZwyciÄ™zca',
                tie: 'Remis',
                newGame: 'Nowa gra',
                errorMinAnswers: 'Podaj co najmniej 2 odpowiedzi',
                errorEmptyName: 'Podaj swoje imiÄ™',
                errorEmptyCode: 'Podaj kod gry',
                errorEmptyQuestion: 'Podaj treÅ›Ä‡ pytania',
                errorInvalidCode: 'Podaj prawidÅ‚owy 4-cyfrowy kod gry',
                errorConnection: 'BÅ‚Ä…d poÅ‚Ä…czenia z serwerem'
            },
            en: {
                subtitle: 'Game for two players',
                createNewGame: 'Create New Game',
                yourName: 'Your Name',
                enterYourName: 'Enter your name...',
                createNewGameButton: 'Create New Game',
                or: 'or',
                joinGame: 'Join Game',
                gameCode: 'Game Code',
                enterGameCode: 'Enter 4-digit code...',
                joinGameButton: 'Join Game',
                waitingForPlayer: 'Waiting for second player...',
                gameCodeLabel: 'Game Code',
                shareCode: 'Share this code with the second player',
                backToMenu: 'Back to Menu',
                gameInProgress: 'Game in Progress',
                round: 'Round',
                completedRounds: 'Completed Rounds',
                yourTurnAsk: 'Your turn - ask a question!',
                questionText: 'Question Text',
                enterQuestion: 'Enter your question...',
                answers: 'Answers',
                answer: 'Answer',
                selectCorrectAnswer: 'Select the correct answer',
                askQuestion: 'Ask Question',
                playerAsks: '{name} asks',
                waiting: 'Waiting',
                playerThinking: '{name} is thinking about the answer',
                playerPreparing: '{name} is preparing a question',
                gameFinished: 'Game Finished!',
                winner: 'Winner',
                tie: 'Tie',
                newGame: 'New Game',
                errorMinAnswers: 'Provide at least 2 answers',
                errorEmptyName: 'Enter your name',
                errorEmptyCode: 'Enter game code',
                errorEmptyQuestion: 'Enter question text',
                errorInvalidCode: 'Enter a valid 4-digit game code',
                errorConnection: 'Connection error with server'
            },
            es: {
                subtitle: 'Juego para dos jugadores',
                createNewGame: 'Crear Nuevo Juego',
                yourName: 'Tu Nombre',
                enterYourName: 'Ingresa tu nombre...',
                createNewGameButton: 'Crear Nuevo Juego',
                or: 'o',
                joinGame: 'Unirse al Juego',
                gameCode: 'CÃ³digo del Juego',
                enterGameCode: 'Ingresa cÃ³digo de 4 dÃ­gitos...',
                joinGameButton: 'Unirse al Juego',
                waitingForPlayer: 'Esperando al segundo jugador...',
                gameCodeLabel: 'CÃ³digo del Juego',
                shareCode: 'Comparte este cÃ³digo con el segundo jugador',
                backToMenu: 'Volver al MenÃº',
                gameInProgress: 'Juego en Progreso',
                round: 'Ronda',
                completedRounds: 'Rondas Completadas',
                yourTurnAsk: 'Â¡Tu turno - haz una pregunta!',
                questionText: 'Texto de la Pregunta',
                enterQuestion: 'Ingresa tu pregunta...',
                answers: 'Respuestas',
                answer: 'Respuesta',
                selectCorrectAnswer: 'Selecciona la respuesta correcta',
                askQuestion: 'Hacer Pregunta',
                playerAsks: '{name} pregunta',
                waiting: 'Esperando',
                playerThinking: '{name} estÃ¡ pensando en la respuesta',
                playerPreparing: '{name} estÃ¡ preparando una pregunta',
                gameFinished: 'Â¡Juego Terminado!',
                winner: 'Ganador',
                tie: 'Empate',
                newGame: 'Nuevo Juego',
                errorMinAnswers: 'Proporciona al menos 2 respuestas',
                errorEmptyName: 'Ingresa tu nombre',
                errorEmptyCode: 'Ingresa el cÃ³digo del juego',
                errorEmptyQuestion: 'Ingresa el texto de la pregunta',
                errorInvalidCode: 'Ingresa un cÃ³digo de juego vÃ¡lido de 4 dÃ­gitos',
                errorConnection: 'Error de conexiÃ³n con el servidor'
            },
            de: {
                subtitle: 'Spiel fÃ¼r zwei Spieler',
                createNewGame: 'Neues Spiel Erstellen',
                yourName: 'Dein Name',
                enterYourName: 'Gib deinen Namen ein...',
                createNewGameButton: 'Neues Spiel Erstellen',
                or: 'oder',
                joinGame: 'Spiel Beitreten',
                gameCode: 'Spielcode',
                enterGameCode: 'Gib 4-stelligen Code ein...',
                joinGameButton: 'Spiel Beitreten',
                waitingForPlayer: 'Warten auf zweiten Spieler...',
                gameCodeLabel: 'Spielcode',
                shareCode: 'Teile diesen Code mit dem zweiten Spieler',
                backToMenu: 'ZurÃ¼ck zum MenÃ¼',
                gameInProgress: 'Spiel lÃ¤uft',
                round: 'Runde',
                completedRounds: 'Abgeschlossene Runden',
                yourTurnAsk: 'Du bist dran - stelle eine Frage!',
                questionText: 'Fragetext',
                enterQuestion: 'Gib deine Frage ein...',
                answers: 'Antworten',
                answer: 'Antwort',
                selectCorrectAnswer: 'WÃ¤hle die richtige Antwort',
                askQuestion: 'Frage Stellen',
                playerAsks: '{name} fragt',
                waiting: 'Warten',
                playerThinking: '{name} denkt Ã¼ber die Antwort nach',
                playerPreparing: '{name} bereitet eine Frage vor',
                gameFinished: 'Spiel Beendet!',
                winner: 'Gewinner',
                tie: 'Unentschieden',
                newGame: 'Neues Spiel',
                errorMinAnswers: 'Gib mindestens 2 Antworten an',
                errorEmptyName: 'Gib deinen Namen ein',
                errorEmptyCode: 'Gib den Spielcode ein',
                errorEmptyQuestion: 'Gib den Fragetext ein',
                errorInvalidCode: 'Gib einen gÃ¼ltigen 4-stelligen Spielcode ein',
                errorConnection: 'Verbindungsfehler mit dem Server'
            }
        };

        // Tworzenie instancji i18n
        const i18n = createI18n({
            locale: getBrowserLanguage(),
            fallbackLocale: 'en',
            messages
        });

        const app = createApp({
            setup() {
                const gameState = ref('menu');
                const playerNameCreate = ref('');
                const playerNameJoin = ref('');
                const currentPlayerName = ref('');
                const gameCode = ref('');
                const room = ref(null);
                const currentPlayer = ref(null);
                const socket = ref(null);
                const message = ref('');
                const error = ref('');
                const connectionState = ref('disconnected');

                // ObsÅ‚uga jÄ™zyka
                const currentLocale = ref(getBrowserLanguage());

                const changeLanguage = (locale) => {
                    i18n.global.locale = locale;
                    currentLocale.value = locale;
                    document.documentElement.lang = locale;
                    localStorage.setItem('preferredLanguage', locale);
                };

                // Inicjalizacja - ustaw jÄ™zyk na podstawie getBrowserLanguage
                const initialLocale = getBrowserLanguage();
                changeLanguage(initialLocale);

                const questionForm = ref({
                    text: '',
                    answers: ['', '', '', '', ''],
                    correctAnswer: 0
                });

                const selectedAnswer = ref(-1);

                const isMyTurn = computed(() => {
                    return room.value && currentPlayer.value &&
                           room.value.currentPlayerTurn === currentPlayer.value.id;
                });

                const otherPlayer = computed(() => {
                    if (!room.value || !currentPlayer.value) return null;
                    return room.value.players.find(p => p.id !== currentPlayer.value.id);
                });

                const isConnected = computed(() => {
                    return connectionState.value === 'connected';
                });

                const isReconnecting = computed(() => {
                    return connectionState.value === 'reconnecting';
                });

                const canAskQuestion = computed(() => {
                    return isMyTurn.value && !room.value?.currentQuestion;
                });

                const canAnswerQuestion = computed(() => {
                    return !isMyTurn.value && room.value?.currentQuestion;
                });

                // Game state persistence
                function saveGameState() {
                    if (room.value && currentPlayer.value) {
                        const state = {
                            room: room.value,
                            currentPlayer: currentPlayer.value,
                            currentPlayerName: currentPlayerName.value,
                            timestamp: Date.now()
                        };
                        localStorage.setItem('quizGameState', JSON.stringify(state));
                    }
                }

                function clearGameState() {
                    localStorage.removeItem('quizGameState');
                }

                function loadGameState() {
                    const saved = localStorage.getItem('quizGameState');
                    if (saved) {
                        try {
                            const state = JSON.parse(saved);
                            // Check if state is not too old (24 hours)
                            if (Date.now() - state.timestamp < 24 * 60 * 60 * 1000) {
                                return state;
                            } else {
                                clearGameState();
                            }
                        } catch (e) {
                            console.error('Failed to parse saved game state:', e);
                            clearGameState();
                        }
                    }
                    return null;
                }

                function connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}`;

                    socket.value = new WebSocket(wsUrl);

                    socket.value.onopen = () => {
                        console.log('Connected to server');
                        connectionState.value = 'connected';
                        error.value = '';

                        // Check if we need to rejoin a game
                        const savedState = loadGameState();
                        if (savedState && savedState.room && savedState.currentPlayer) {
                            console.log('Attempting to rejoin game:', savedState.room.code, 'with ID:', savedState.room.id);
                            socket.value.send(JSON.stringify({
                                type: 'rejoin',
                                data: {
                                    roomId: savedState.room.id,  // Use actual room ID, not code
                                    playerId: savedState.currentPlayer.id,
                                    playerName: savedState.currentPlayer.name
                                }
                            }));
                        }
                    };

                    socket.value.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        handleServerMessage(data);
                    };

                    socket.value.onclose = () => {
                        console.log('Disconnected from server');
                        // Only show disconnection error if we're not intentionally resetting
                        if (gameState.value !== 'menu') {
                            connectionState.value = 'disconnected';
                            error.value = 'PoÅ‚Ä…czenie z serwerem zostaÅ‚o przerwane';
                        }
                    };

                    socket.value.onerror = (err) => {
                        console.error('WebSocket error:', err);
                        // Only show connection error if we're not intentionally resetting
                        if (gameState.value !== 'menu') {
                            connectionState.value = 'disconnected';
                            error.value = 'BÅ‚Ä…d poÅ‚Ä…czenia z serwerem';
                        }
                    };
                }

                function handleServerMessage(data) {
                    console.log('Received message:', data.type, data);

                    // Save game state on any game update
                    if (data.type === 'gameUpdate' || data.type === 'playerDisconnected' || data.type === 'rejoinSuccess') {
                        saveGameState();
                    }

                    switch (data.type) {
                        case 'gameUpdate':
                            console.log('Game update received:', data.data);
                            room.value = data.data.room;
                            message.value = data.data.message || '';

                            if (room.value && currentPlayerName.value) {
                                currentPlayer.value = room.value.players.find(p => p.name === currentPlayerName.value);
                                console.log('Current player identified:', currentPlayer.value);
                                console.log('Room current turn:', room.value.currentPlayerTurn);
                                console.log('Current question:', room.value.currentQuestion);
                                console.log('isMyTurn:', isMyTurn.value);
                                console.log('canAskQuestion:', canAskQuestion.value);
                                console.log('canAnswerQuestion:', canAnswerQuestion.value);
                            }

                            if (room.value) {
                                if (room.value.gameState === 'waiting') {
                                    gameState.value = 'waiting';
                                } else if (room.value.gameState === 'playing') {
                                    gameState.value = 'playing';
                                } else if (room.value.gameState === 'finished') {
                                    gameState.value = 'finished';
                                    // Clear saved state when game finishes
                                    clearGameState();
                                    // Let players restart on demand using the button
                                }
                            }
                            break;

                        case 'rejoinSuccess':
                            console.log('Rejoin successful:', data.data);
                            room.value = data.data.room;
                            currentPlayer.value = data.data.player;
                            message.value = data.data.message || 'PomyÅ›lnie przywrÃ³cono poÅ‚Ä…czenie!';

                            if (room.value) {
                                if (room.value.gameState === 'waiting') {
                                    gameState.value = 'waiting';
                                } else if (room.value.gameState === 'playing') {
                                    gameState.value = 'playing';
                                } else if (room.value.gameState === 'finished') {
                                    gameState.value = 'finished';
                                }
                            }
                            break;

                        case 'rejoinFailed':
                            console.log('Rejoin failed:', data.data.message);
                            error.value = data.data.message;
                            clearGameState(); // Clear invalid state
                            gameState.value = 'menu';
                            break;

                        case 'error':
                            console.error('Server error:', data.data.message);
                            error.value = data.data.message;
                            break;

                        case 'playerDisconnected':
                            room.value = data.data.room;
                            message.value = data.data.message;
                            break;
                    }
                }

                function createGame() {
                    if (!playerNameCreate.value.trim()) {
                        error.value = i18n.global.t('errorEmptyName');
                        return;
                    }

                    currentPlayerName.value = playerNameCreate.value.trim();
                    error.value = '';
                    connectWebSocket();

                    socket.value.onopen = () => {
                        socket.value.send(JSON.stringify({
                            type: 'create',
                            data: { playerName: currentPlayerName.value }
                        }));
                    };
                }

                function joinGame() {
                    if (!playerNameJoin.value.trim()) {
                        error.value = i18n.global.t('errorEmptyName');
                        return;
                    }

                    if (!gameCode.value.trim() || gameCode.value.trim().length !== 4) {
                        error.value = i18n.global.t('errorInvalidCode');
                        return;
                    }

                    currentPlayerName.value = playerNameJoin.value.trim();
                    error.value = '';
                    connectWebSocket();

                    socket.value.onopen = () => {
                        socket.value.send(JSON.stringify({
                            type: 'join',
                            data: {
                                playerName: currentPlayerName.value,
                                gameCode: gameCode.value.trim().toUpperCase()
                            }
                        }));
                    };
                }

                function submitQuestion() {
                    console.log('Submitting question...');
                    console.log('Current player:', currentPlayer.value);
                    console.log('Room current turn:', room.value?.currentPlayerTurn);
                    console.log('isMyTurn:', isMyTurn.value);

                    if (!questionForm.value.text.trim()) {
                        error.value = i18n.global.t('errorEmptyQuestion');
                        return;
                    }

                    const filledAnswers = questionForm.value.answers.filter(a => a.trim());
                    if (filledAnswers.length < 2) {
                        error.value = i18n.global.t('errorMinAnswers');
                        return;
                    }

                    error.value = '';

                    socket.value.send(JSON.stringify({
                        type: 'question',
                        data: {
                            text: questionForm.value.text.trim(),
                            answers: questionForm.value.answers.map(a => a.trim()).filter(a => a),
                            correctAnswer: questionForm.value.correctAnswer
                        }
                    }));

                    questionForm.value = {
                        text: '',
                        answers: ['', '', '', '', ''],
                        correctAnswer: 0
                    };
                }

                function submitAnswer() {
                    if (selectedAnswer.value === -1) {
                        error.value = 'Wybierz odpowiedÅº';
                        return;
                    }
                    
                    error.value = '';
                    
                    socket.value.send(JSON.stringify({
                        type: 'answer',
                        data: {
                            questionId: room.value.currentQuestion.id,
                            selectedAnswer: selectedAnswer.value
                        }
                    }));
                    
                    selectedAnswer.value = -1;
                }

                function resetGame() {
                    gameState.value = 'menu';
                    playerNameCreate.value = '';
                    playerNameJoin.value = '';
                    currentPlayerName.value = '';
                    gameCode.value = '';
                    room.value = null;
                    currentPlayer.value = null;
                    message.value = '';
                    error.value = '';
                    selectedAnswer.value = -1;

                    // Clear saved game state
                    clearGameState();

                    // Don't close WebSocket connection - keep it open for new games
                    // The connection should remain active for the same session
                }

                function resetGameAfterFinish() {
                    // Special reset for game end - keep connection open
                    gameState.value = 'menu';
                    playerNameCreate.value = '';
                    playerNameJoin.value = '';
                    gameCode.value = '';
                    room.value = null;
                    currentPlayer.value = null;
                    message.value = '';
                    error.value = '';
                    selectedAnswer.value = -1;

                    // Clear saved game state but keep connection
                    clearGameState();

                    // Reset connection state to avoid disconnection alerts
                    connectionState.value = 'connected';
                }

                onMounted(() => {
                    console.log('Component mounted, checking for saved game state...');

                    // Auto-connect on page load if we have saved game state
                    const savedGameState = localStorage.getItem('quizGameState');
                    console.log('Saved game state found:', !!savedGameState);

                    if (savedGameState) {
                        try {
                            const state = JSON.parse(savedGameState);
                            console.log('Parsed state:', state);

                            if (state.room && state.currentPlayer) {
                                console.log('Restoring game:', state.room.code, 'ID:', state.room.id);
                                room.value = state.room;
                                currentPlayer.value = state.currentPlayer;
                                currentPlayerName.value = state.currentPlayerName;
                                gameState.value = 'reconnecting';
                                connectionState.value = 'connecting';
                                error.value = 'Przywracanie poÅ‚Ä…czenia...';

                                // Attempt to reconnect
                                setTimeout(() => {
                                    console.log('Connecting WebSocket...');
                                    connectWebSocket();
                                }, 500);
                            }
                        } catch (e) {
                            console.error('Failed to restore game state:', e);
                            localStorage.removeItem('quizGameState');
                        }
                    }

                    // Handle page visibility changes for mobile
                    function handleVisibilityChange() {
                        if (document.hidden) {
                            console.log('Page hidden - maintaining connection');
                        } else {
                            console.log('Page visible - checking connection');
                            if (socket.value && socket.value.readyState !== WebSocket.OPEN && room.value) {
                                connectWebSocket();
                            }
                        }
                    }

                    function handleOnline() {
                        console.log('Network online');
                        if (room.value && connectionState.value !== 'connected') {
                            connectWebSocket();
                        }
                    }

                    function handleOffline() {
                        console.log('Network offline');
                        error.value = 'Brak poÅ‚Ä…czenia internetowego';
                        connectionState.value = 'disconnected';
                    }

                    document.addEventListener('visibilitychange', handleVisibilityChange);
                    window.addEventListener('online', handleOnline);
                    window.addEventListener('offline', handleOffline);

                    // Store references for cleanup
                    window.__quizGameHandlers = {
                        visibility: handleVisibilityChange,
                        online: handleOnline,
                        offline: handleOffline
                    };
                });

                onUnmounted(() => {
                    // Clean up event listeners using stored references
                    if (window.__quizGameHandlers) {
                        document.removeEventListener('visibilitychange', window.__quizGameHandlers.visibility);
                        window.removeEventListener('online', window.__quizGameHandlers.online);
                        window.removeEventListener('offline', window.__quizGameHandlers.offline);
                        delete window.__quizGameHandlers;
                    }

                    // Clean up connection
                    if (socket.value) {
                        socket.value.close();
                        socket.value = null;
                    }
                });

                return {
                    gameState,
                    playerNameCreate,
                    playerNameJoin,
                    currentPlayerName,
                    gameCode,
                    room,
                    currentPlayer,
                    message,
                    error,
                    questionForm,
                    selectedAnswer,
                    isMyTurn,
                    otherPlayer,
                    canAskQuestion,
                    canAnswerQuestion,
                    isConnected,
                    isReconnecting,
                    currentLocale,
                    changeLanguage,
                    createGame,
                    joinGame,
                    submitQuestion,
                    submitAnswer,
                    resetGame
                };
            }
        });

        // UÅ¼ywanie i18n plugin
        app.use(i18n);
        app.mount('#app');
    </script>
</body>
</html>